From f639a9c3a7f70789c41aec57c417ade46b25ad2a Mon Sep 17 00:00:00 2001
From: liberodark <liberodark@gmail.com>
Date: Wed, 26 Nov 2025 11:23:23 +0100
Subject: [PATCH 01/18] mm/slub: randomize the cgroup kmalloc caches

---
 include/linux/slab.h | 20 +++++++++++++++-----
 mm/slab_common.c     | 40 ++++++++++++++++++++--------------------
 2 files changed, 35 insertions(+), 25 deletions(-)

diff --git a/include/linux/slab.h b/include/linux/slab.h
index b35e2db7e..798e691a2 100644
--- a/include/linux/slab.h
+++ b/include/linux/slab.h
@@ -591,6 +591,8 @@ enum kmalloc_cache_type {
 #ifdef CONFIG_MEMCG
 	KMALLOC_CGROUP,
 #endif
+	KMALLOC_CGROUP_RANDOM_START = KMALLOC_CGROUP,
+	KMALLOC_CGROUP_RANDOM_END = KMALLOC_CGROUP_RANDOM_START + RANDOM_KMALLOC_CACHES_NR,
 	NR_KMALLOC_TYPES
 };
 
@@ -608,6 +610,12 @@ extern kmem_buckets kmalloc_caches[NR_KMALLOC_TYPES];
 
 extern unsigned long random_kmalloc_seed;
 
+static __always_inline enum kmalloc_cache_type kmalloc_random_cache(enum kmalloc_cache_type base, unsigned long caller)
+{
+	/* RANDOM_KMALLOC_CACHES_NR (=15) copies + the base */
+	return base + hash_64(caller ^ random_kmalloc_seed, ilog2(RANDOM_KMALLOC_CACHES_NR + 1));
+}
+
 static __always_inline enum kmalloc_cache_type kmalloc_type(gfp_t flags, unsigned long caller)
 {
 	/*
@@ -616,9 +624,7 @@ static __always_inline enum kmalloc_cache_type kmalloc_type(gfp_t flags, unsigne
 	 */
 	if (likely((flags & KMALLOC_NOT_NORMAL_BITS) == 0))
 #ifdef CONFIG_RANDOM_KMALLOC_CACHES
-		/* RANDOM_KMALLOC_CACHES_NR (=15) copies + the KMALLOC_NORMAL */
-		return KMALLOC_RANDOM_START + hash_64(caller ^ random_kmalloc_seed,
-						      ilog2(RANDOM_KMALLOC_CACHES_NR + 1));
+		return kmalloc_random_cache(KMALLOC_RANDOM_START, caller);
 #else
 		return KMALLOC_NORMAL;
 #endif
@@ -634,8 +640,12 @@ static __always_inline enum kmalloc_cache_type kmalloc_type(gfp_t flags, unsigne
 		return KMALLOC_DMA;
 	if (!IS_ENABLED(CONFIG_MEMCG) || (flags & __GFP_RECLAIMABLE))
 		return KMALLOC_RECLAIM;
-	else
-		return KMALLOC_CGROUP;
+
+#ifdef CONFIG_RANDOM_KMALLOC_CACHES
+	return kmalloc_random_cache(KMALLOC_CGROUP_RANDOM_START, caller);
+#else
+	return KMALLOC_CGROUP;
+#endif
 }
 
 /*
diff --git a/mm/slab_common.c b/mm/slab_common.c
index 477fa471d..3a14d4a22 100644
--- a/mm/slab_common.c
+++ b/mm/slab_common.c
@@ -760,7 +760,8 @@ EXPORT_SYMBOL(kmalloc_size_roundup);
 #endif
 
 #ifdef CONFIG_MEMCG
-#define KMALLOC_CGROUP_NAME(sz)	.name[KMALLOC_CGROUP] = "kmalloc-cg-" #sz,
+#define KMALLOC_CGROUP_NAME(sz)	.name[KMALLOC_CGROUP] = "kmalloc-cg-" #sz, \
+	KMALLOC_RANDOM_NAME(RANDOM_KMALLOC_CACHES_NR, sz, KMALLOC_CGROUP_RANDOM_START, "cg-")
 #else
 #define KMALLOC_CGROUP_NAME(sz)
 #endif
@@ -773,24 +774,24 @@ EXPORT_SYMBOL(kmalloc_size_roundup);
 
 #ifdef CONFIG_RANDOM_KMALLOC_CACHES
 #define __KMALLOC_RANDOM_CONCAT(a, b) a ## b
-#define KMALLOC_RANDOM_NAME(N, sz) __KMALLOC_RANDOM_CONCAT(KMA_RAND_, N)(sz)
-#define KMA_RAND_1(sz)                  .name[KMALLOC_RANDOM_START +  1] = "kmalloc-rnd-01-" #sz,
-#define KMA_RAND_2(sz)  KMA_RAND_1(sz)  .name[KMALLOC_RANDOM_START +  2] = "kmalloc-rnd-02-" #sz,
-#define KMA_RAND_3(sz)  KMA_RAND_2(sz)  .name[KMALLOC_RANDOM_START +  3] = "kmalloc-rnd-03-" #sz,
-#define KMA_RAND_4(sz)  KMA_RAND_3(sz)  .name[KMALLOC_RANDOM_START +  4] = "kmalloc-rnd-04-" #sz,
-#define KMA_RAND_5(sz)  KMA_RAND_4(sz)  .name[KMALLOC_RANDOM_START +  5] = "kmalloc-rnd-05-" #sz,
-#define KMA_RAND_6(sz)  KMA_RAND_5(sz)  .name[KMALLOC_RANDOM_START +  6] = "kmalloc-rnd-06-" #sz,
-#define KMA_RAND_7(sz)  KMA_RAND_6(sz)  .name[KMALLOC_RANDOM_START +  7] = "kmalloc-rnd-07-" #sz,
-#define KMA_RAND_8(sz)  KMA_RAND_7(sz)  .name[KMALLOC_RANDOM_START +  8] = "kmalloc-rnd-08-" #sz,
-#define KMA_RAND_9(sz)  KMA_RAND_8(sz)  .name[KMALLOC_RANDOM_START +  9] = "kmalloc-rnd-09-" #sz,
-#define KMA_RAND_10(sz) KMA_RAND_9(sz)  .name[KMALLOC_RANDOM_START + 10] = "kmalloc-rnd-10-" #sz,
-#define KMA_RAND_11(sz) KMA_RAND_10(sz) .name[KMALLOC_RANDOM_START + 11] = "kmalloc-rnd-11-" #sz,
-#define KMA_RAND_12(sz) KMA_RAND_11(sz) .name[KMALLOC_RANDOM_START + 12] = "kmalloc-rnd-12-" #sz,
-#define KMA_RAND_13(sz) KMA_RAND_12(sz) .name[KMALLOC_RANDOM_START + 13] = "kmalloc-rnd-13-" #sz,
-#define KMA_RAND_14(sz) KMA_RAND_13(sz) .name[KMALLOC_RANDOM_START + 14] = "kmalloc-rnd-14-" #sz,
-#define KMA_RAND_15(sz) KMA_RAND_14(sz) .name[KMALLOC_RANDOM_START + 15] = "kmalloc-rnd-15-" #sz,
+#define KMALLOC_RANDOM_NAME(N, sz, base, type) __KMALLOC_RANDOM_CONCAT(KMA_RAND_, N)(sz, base, type)
+#define KMA_RAND_1(sz, base, type)                        .name[base +  1] = "kmalloc-rnd-01-" type #sz,
+#define KMA_RAND_2(sz, base, type)  KMA_RAND_1(sz, base, type)  .name[base +  2] = "kmalloc-rnd-02-" type #sz,
+#define KMA_RAND_3(sz, base, type)  KMA_RAND_2(sz, base, type)  .name[base +  3] = "kmalloc-rnd-03-" type #sz,
+#define KMA_RAND_4(sz, base, type)  KMA_RAND_3(sz, base, type)  .name[base +  4] = "kmalloc-rnd-04-" type #sz,
+#define KMA_RAND_5(sz, base, type)  KMA_RAND_4(sz, base, type)  .name[base +  5] = "kmalloc-rnd-05-" type #sz,
+#define KMA_RAND_6(sz, base, type)  KMA_RAND_5(sz, base, type)  .name[base +  6] = "kmalloc-rnd-06-" type #sz,
+#define KMA_RAND_7(sz, base, type)  KMA_RAND_6(sz, base, type)  .name[base +  7] = "kmalloc-rnd-07-" type #sz,
+#define KMA_RAND_8(sz, base, type)  KMA_RAND_7(sz, base, type)  .name[base +  8] = "kmalloc-rnd-08-" type #sz,
+#define KMA_RAND_9(sz, base, type)  KMA_RAND_8(sz, base, type)  .name[base +  9] = "kmalloc-rnd-09-" type #sz,
+#define KMA_RAND_10(sz, base, type) KMA_RAND_9(sz, base, type)  .name[base + 10] = "kmalloc-rnd-10-" type #sz,
+#define KMA_RAND_11(sz, base, type) KMA_RAND_10(sz, base, type) .name[base + 11] = "kmalloc-rnd-11-" type #sz,
+#define KMA_RAND_12(sz, base, type) KMA_RAND_11(sz, base, type) .name[base + 12] = "kmalloc-rnd-12-" type #sz,
+#define KMA_RAND_13(sz, base, type) KMA_RAND_12(sz, base, type) .name[base + 13] = "kmalloc-rnd-13-" type #sz,
+#define KMA_RAND_14(sz, base, type) KMA_RAND_13(sz, base, type) .name[base + 14] = "kmalloc-rnd-14-" type #sz,
+#define KMA_RAND_15(sz, base, type) KMA_RAND_14(sz, base, type) .name[base + 15] = "kmalloc-rnd-15-" type #sz,
 #else // CONFIG_RANDOM_KMALLOC_CACHES
-#define KMALLOC_RANDOM_NAME(N, sz)
+#define KMALLOC_RANDOM_NAME(N, sz, base, type)
 #endif
 
 #define INIT_KMALLOC_INFO(__size, __short_size)			\
@@ -799,7 +800,7 @@ EXPORT_SYMBOL(kmalloc_size_roundup);
 	KMALLOC_RCL_NAME(__short_size)				\
 	KMALLOC_CGROUP_NAME(__short_size)			\
 	KMALLOC_DMA_NAME(__short_size)				\
-	KMALLOC_RANDOM_NAME(RANDOM_KMALLOC_CACHES_NR, __short_size)	\
+	KMALLOC_RANDOM_NAME(RANDOM_KMALLOC_CACHES_NR, __short_size, KMALLOC_RANDOM_START, "")	\
 	.size = __size,						\
 }
 
@@ -1337,4 +1338,3 @@ EXPORT_TRACEPOINT_SYMBOL(kmalloc);
 EXPORT_TRACEPOINT_SYMBOL(kmem_cache_alloc);
 EXPORT_TRACEPOINT_SYMBOL(kfree);
 EXPORT_TRACEPOINT_SYMBOL(kmem_cache_free);
-
-- 
2.50.1

